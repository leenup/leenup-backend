{
  skip_install_trust
  {$CADDY_GLOBAL_OPTIONS}
  auto_https disable_redirects

  frankenphp {
    {$FRANKENPHP_CONFIG}
    worker {
      env APP_RUNTIME Runtime\FrankenPhpSymfony\Runtime
      file ./public/index.php
      {$FRANKENPHP_WORKER_CONFIG}
    }
  }
}

{$CADDY_EXTRA_CONFIG}

:80 {
  log {
    format filter {
      request>uri query {
        replace authorization REDACTED
      }
    }
  }

  root * /app/public
  encode zstd br gzip

  mercure {
    transport_url {$MERCURE_TRANSPORT_URL:bolt:///data/mercure.db}
    publisher_jwt {env.MERCURE_PUBLISHER_JWT_KEY} {env.MERCURE_PUBLISHER_JWT_ALG}
    subscriber_jwt {env.MERCURE_SUBSCRIBER_JWT_KEY} {env.MERCURE_SUBSCRIBER_JWT_ALG}
    anonymous
    subscriptions
    {$MERCURE_EXTRA_DIRECTIVES}
  }

  vulcain

  header ?Link `</docs.jsonld>; rel="http://www.w3.org/ns/hydra/core#apiDocumentation", </.well-known/mercure>; rel="mercure"`
  header ?Permissions-Policy "browsing-topics=()"

  route {
    @pwa expression `(
      header({'Accept': '*text/html*'})
      && !path(
        '/docs*', '/graphql*', '/bundles*', '/contexts*', '/_profiler*', '/_wdt*',
        '*.json*', '*.html', '*.csv', '*.yml', '*.yaml', '*.xml'
      )
    )
    || path('/favicon.ico', '/manifest.json', '/robots.txt', '/sitemap*', '/_next*', '/__next*')
    || query({'_rsc': '*'})`

    reverse_proxy @pwa http://{$PWA_UPSTREAM}

    @phpRoute {
      not path /.well-known/mercure*
      not file {path}
    }
    rewrite @phpRoute /index.php

    php
    file_server
  }
}
