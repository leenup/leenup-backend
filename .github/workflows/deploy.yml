name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_strategy:
        description: "Deployment strategy: git or registry"
        required: false
        default: "git"
      compose_args:
        description: "Optional docker compose args (e.g. -f compose.yaml -f compose.prod.yaml)"
        required: false
        default: ""

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  ssh-test:
    name: SSH smoke test
    runs-on: ubuntu-latest
    steps:
      - name: Prepare SSH key
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "${DEPLOY_SSH_KEY}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      - name: Run remote checks
        shell: bash
        run: |
          set -euo pipefail
          ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes "${DEPLOY_USER}@${DEPLOY_HOST}" <<'REMOTE'
          set -euo pipefail
          whoami
          docker --version
          docker compose version
          docker ps
          ls -la /srv/apps /srv/reverse-proxy
          REMOTE
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: ssh-test
    steps:
      - name: Prepare SSH key
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "${DEPLOY_SSH_KEY}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      - name: Deploy
        shell: bash
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_REPO: ${{ secrets.DEPLOY_REPO }}
          DEPLOY_REPO_SSH_KEY: ${{ secrets.DEPLOY_REPO_SSH_KEY }}
          DEPLOY_STRATEGY: ${{ inputs.deploy_strategy || 'git' }}
          DEPLOY_COMPOSE_ARGS: ${{ inputs.compose_args || secrets.DEPLOY_COMPOSE_ARGS }}
        run: |
          set -euo pipefail
          ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes "${DEPLOY_USER}@${DEPLOY_HOST}" <<REMOTE
          set -euo pipefail

          DEPLOY_PATH="${DEPLOY_PATH}"
          DEPLOY_REPO="${DEPLOY_REPO}"
          DEPLOY_STRATEGY="${DEPLOY_STRATEGY}"
          DEPLOY_COMPOSE_ARGS="${DEPLOY_COMPOSE_ARGS}"
          DEPLOY_REPO_SSH_KEY="$(cat <<'KEY'
${DEPLOY_REPO_SSH_KEY}
KEY
)"

          if [ -z "${DEPLOY_PATH:-}" ]; then
            echo "DEPLOY_PATH is required" >&2
            exit 1
          fi

          mkdir -p "$DEPLOY_PATH"
          cd "$DEPLOY_PATH"

          if [ "${DEPLOY_STRATEGY:-git}" = "git" ]; then
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            if [ -n "${DEPLOY_REPO_SSH_KEY:-}" ]; then
              repo_key_path=~/.ssh/deploy_repo_key
              printf '%s\n' "$DEPLOY_REPO_SSH_KEY" > "$repo_key_path"
              chmod 600 "$repo_key_path"
              export GIT_SSH_COMMAND="ssh -i $repo_key_path -o IdentitiesOnly=yes"
            fi
            ssh-keyscan -H github.com >> ~/.ssh/known_hosts

            if [ -z "${DEPLOY_REPO:-}" ]; then
              echo "DEPLOY_REPO is required for git strategy" >&2
              exit 1
            fi

            if [ ! -d .git ]; then
              git clone --depth 1 "$DEPLOY_REPO" .
            else
              git fetch origin main
              git reset --hard origin/main
            fi
          fi

          compose_args="${DEPLOY_COMPOSE_ARGS:-}"
          if [ -n "$compose_args" ]; then
            docker compose $compose_args pull
            docker compose $compose_args up -d --remove-orphans
            docker compose $compose_args ps
          else
            docker compose pull
            docker compose up -d --remove-orphans
            docker compose ps
          fi
          REMOTE
